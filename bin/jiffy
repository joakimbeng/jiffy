#!/usr/bin/env node

var dir = process.cwd(),
    join = require('path').join,
    ext = require('path').extname,
    base = require('path').basename,
    dirname = require('path').dirname,
    fs = require('klei-fs'),
    exists = fs.existsSync,
    marked = require('marked'),
    kleiDust = require('klei-dust'),
    pkg = require('../package.json'),
    url = require('url'),
    hljs = require('highlight.js'),
    q = require('q'),
    complete = require('../lib/complete'),
    extend = require('../lib/extend'),
    settings = require('../lib/settings');

console.log('          __  __');
console.log('     / Â´ /_  /_');
console.log('  __/ / /   /  /__/  v.' + pkg.version);
console.log('               __/');
console.log('');

settings = settings(dir);

if (!exists(settings.postsDir))
  throw new Error('Missing posts directory: "' + settings.postsDir + '"');

var started = Date.now();
console.log('started');


if (!exists(settings.buildDir)) {
  console.log('Creating build directory...');
  fs.mkdirSync(settings.buildDir, function (err) {
    if (err) throw err;
  });
}

if (!exists(settings.cssDir)) {
  console.log('Creating css directory...');
  fs.mkdirSync(settings.cssDir, function (err) {
    if (err) throw err;
  });
}

kleiDust.setOptions({root: settings.templateDir});

var highlight = function(code, lang){
  if(!hljs) return code;
  if(lang === undefined || !hljs.LANGUAGES[lang]){
    lang = hljs.highlightAuto(code).language;
    if(!lang) return code;
  }
  return hljs.highlight(lang, code).value;
};


function getPostDate(dir) {
  return base(dir).split(' - ')[0];
}

function postNameToFileName (postName) {
  return postName.toLowerCase().split(' ').join('-') + '.html';
}

fs.readJson = function (file, cb) {
  fs.readFile(file, 'utf-8', function (err, source) {
    if (err) return cb(err);
    return cb(null, JSON.parse(source));
  });
};

var readDir = q.denodeify(fs.readdir);
var readFile = q.denodeify(fs.readFile);
var readJson = q.denodeify(fs.readJson);
var stat = q.denodeify(fs.stat);
var dust = q.denodeify(kleiDust.dust);
var writeFile = q.denodeify(fs.writeFile);

function isJson (file) {
  return ext(file) === '.json';
}

function isMarkdown (file) {
  return ['.md', '.markdown'].indexOf(ext(file)) >= 0;
}


var postsPromise = readDir(settings.postsDir).then(function (postDirs) {
  return q.all(postDirs.map(function (dir) {
    var post = {};
        post.name = getPostName(dir);
        post.date = getPostDate(dir);
        post.url = postNameToFileName(post.name);

    var markdown = q.defer(),
        created = q.defer(),
        meta = q.defer();

    var hasPost = false,
        hasMeta = false;

    readDir(join(settings.postsDir, dir)).then(function (files) {
      files.forEach(function (fileName) {
        var file = join(settings.postsDir, dir, fileName);
        if (isMarkdown(file)) {
          hasPost = true;
          markdown.resolve(readFile(file, 'utf-8'));
          stat(file).then(function (stats) {
            created.resolve(stats.ctime);
          });
        } else if (isJson(file)) {
          hasMeta = true;
          meta.resolve(readJson(file));
        }
      });
      if (!hasPost)
        markdown.reject(new Error('Missing content (markdown file) for post: ' + post.name));
      if (!hasMeta)
        meta.resolve({});
    });

    post.markdown = markdown.promise;
    post.created = created.promise;
    post.content = getHtml(markdown.promise);
    post.shortContent = getHtml(markdown.promise);
    post.meta = meta.promise;

    return complete(post);
  }));
});


function getPostName(dir) {
  return base(dir).split(' - ').slice(1).join(' - ');
}

function getHtml (markdown) {
  var html = q.defer();
  if (q.isPromise(markdown)) {
    markdown.then(function (markdown) {
      compileMarkdown(html, markdown);
    });
  } else {
    compileMarkdown(html, markdown);
  }
  return html.promise;
}

function compileMarkdown (htmlDeferred, markdown) {
  setTimeout(function () {
    var result = marked(markdown, {highlight: highlight});
    htmlDeferred.resolve(result);
  });
}

postsPromise.then(function (posts) {
  var promises = [];

  var data = {
    blogTitle: settings.title,
    blogUrl: settings.url,
    blogProtocol: url.parse(settings.url).protocol || 'http://',
    disqusShortname: settings.disqusShortname
  };

  promises = posts.map(function (post) {
    post.author = settings.getAuthor(post.meta.author);

    var postData = extend({post: post, url: post.url}, data);

    return dust('post', postData).then(function (out) {
      return writeFile(join(settings.buildDir, post.url), out, 'utf-8');
    });
  });

  var indexData = extend({posts: posts}, data);

  var indexPromise = dust('index', indexData).then(function (out) {
    return writeFile(join(settings.buildDir, 'index.html'), out, 'utf-8');
  });

  promises.push(indexPromise);

  return q.all(promises);
}).then(function () {
  console.log('done', Date.now() - started);
});


// Copy css:
readDir(join(settings.templateDir, 'css'))
  .then(function (files) {
    return q.all(files.map(function (file) {
      return readFile(join(settings.templateDir, 'css', file))
        .then(function (content) {
          return writeFile(join(settings.cssDir, file), content, 'utf-8');
        });
    }));
  })
  .then(function () {
    console.log('Css files copied...');
  });

